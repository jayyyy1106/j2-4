<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>初二4 座位表</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: white;
        }
        h1 {
            text-align: center;
            font-size: 20px;
            margin-bottom: 15px;
        }
        table {
            border-collapse: collapse;
            margin: 0 auto;
            border: 2px solid #000000;
        }
        td {
            width: 100px;
            height: 60px;
            border: 1px solid #d0d0d0;
            text-align: center;
            vertical-align: middle;
            font-size: 14px;
            padding: 2px;
            cursor: pointer;
            background-color: white;
        }
        td.empty {
            background-color: white;
            border: 1px solid #d0d0d0;
        }
        td.teacher {
            background-color: #f2f2f2;
            font-weight: normal;
        }
        .student-info {
            display: flex;
            flex-direction: column;
            justify-content: center;
            height: 100%;
        }
        .student-number {
            font-weight: bold;
            margin-bottom: 2px;
        }
        .student-name {
            font-size: 13px;
        }
        .button-container {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 15px auto;
        }
        button {
            padding: 8px 16px;
            background-color: #f2f2f2;
            color: black;
            border: 1px solid #d0d0d0;
            border-radius: 2px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            background-color: #e6e6e6;
        }
        footer {
            text-align: center;
            margin-top: 20px;
            color: #666;
            font-size: 12px;
            padding: 10px;
        }
    </style>
</head>
<body>
    <h1>座位表</h1>
    <div class="button-container">
        <button id="randomizeBtn">Randomize 随机分配</button>
        <button id="exportBtn">Save As PNG 保存为PNG</button>
        <button id="resetBtn">Reset 重置座位表</button>
    </div>
    <table id="seatTable"></table>

    <footer>
        &copy; <span id="year"></span> 初二4班座位表系统. All rights reserved.
    </footer>

    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script>
        // 学生名单
        const studentNames = [
            "", // 0索引不使用
            "邱穆芸", "陈妍希", "张芷欣", "杨时瑜", "颜姿彤", 
            "许亦萱", "陈嘉恩", "陈钏宁", "李静恩", "刘瑞恩", 
            "黄禹嫣", "妮娅", "陈姿卉", "何汶宣", "王歆茹", 
            "潘姿颖", "施凯馨", "陈渝恩", "戴湘霖", "王婧涵", 
            "许悦影", "朱俊绅", "陈毅祥", "谢承邑", "张智勇", 
            "何凯旭", "赖家禾", "江致承", "刘俊祥", "卢隽益", 
            "廖炫鑫", "刘宽辅", "卢裕城", "黄康桀", "伍思源", 
            "彭宇乐", "潘家扬", "陈晋佑", "陈有权", "余根权", 
            "黄凯杰", "黄恩杰", "黄俊熹", "黄明杰", "叶峻睿", 
            "叶礼诚", "杨仁喆"
        ];

        // 根据提供的Excel布局初始化座位
        const seatLayout = [
            [null, null, null, null, null, null, null, null, null, null, null, null, null, null],
            [null, null, null, null, null, null, null, null, null, null, null, null, null, null],
            [null, null, null, "16", "17", null, null, null, null, null, null, null, null, null],
            [null, null, null, null, null, null, null, null, null, null, null, null, null, null],
            [null, null, null, "1", "13", null, "18", "22", null, "29", "35", null, "32", null],
            [null, null, null, null, null, null, null, null, null, null, null, null, null, null],
            [null, null, null, "5", "34", null, "14", "41", null, "6", "7", null, "38", "24"],
            [null, null, null, null, null, null, null, null, null, null, null, null, null, null],
            ["21", "15", null, "12", "37", null, "4", "8", null, "9", "19", null, "46", "31"],
            [null, null, null, null, null, null, null, null, null, null, null, null, null, null],
            ["11", "20", null, "33", "43", null, "42", "30", null, "2", "10", null, "28", "45"],
            [null, null, null, null, null, null, null, null, null, null, null, null, null, null],
            ["36", "25", null, "47", "44", null, "26", "39", null, "40", "27", null, "23", "40"],
            [null, null, null, null, null, null, "教师", "的座位", null, null, null, null, null, null]
        ];

        // 初始化表格
        function initializeTable() {
            const table = document.getElementById('seatTable');
            table.innerHTML = '';
            
            const savedData = localStorage.getItem('seatTableData');
            let currentData = savedData ? JSON.parse(savedData) : null;
            
            seatLayout.forEach((row, rowIndex) => {
                const tr = document.createElement('tr');
                row.forEach((cell, colIndex) => {
                    const td = document.createElement('td');
                    if (cell === null) {
                        td.className = 'empty';
                    } else if (cell === "教师") {
                        td.className = 'teacher';
                        td.textContent = cell;
                    } else if (cell === "的座位") {
                        td.className = 'teacher';
                        td.textContent = cell;
                    } else {
                        const savedValue = currentData ? currentData[rowIndex][colIndex] : cell;
                        const studentNum = parseInt(savedValue);
                        
                        const studentDiv = document.createElement('div');
                        studentDiv.className = 'student-info';
                        
                        const numberSpan = document.createElement('span');
                        numberSpan.className = 'student-number';
                        numberSpan.textContent = studentNum;
                        
                        const nameSpan = document.createElement('span');
                        nameSpan.className = 'student-name';
                        nameSpan.textContent = studentNames[studentNum] || '';
                        
                        studentDiv.appendChild(numberSpan);
                        studentDiv.appendChild(nameSpan);
                        td.appendChild(studentDiv);
                        
                        td.addEventListener('click', function() {
                            const newNum = prompt("输入新号码 (1-47):", studentNum);
                            if (newNum !== null && newNum !== "" && !isNaN(newNum)) {
                                const num = parseInt(newNum);
                                if (num >= 1 && num <= 47) {
                                    if ((num === 2 || num === 30) && !checkPair(num === 2 ? 30 : 2, this)) {
                                        alert("学生2和30必须坐在一起");
                                        return;
                                    }
                                    if ((num === 4 || num === 42) && !checkPair(num === 4 ? 42 : 4, this)) {
                                        alert("学生4和42必须坐在一起");
                                        return;
                                    }
                                    
                                    numberSpan.textContent = num;
                                    nameSpan.textContent = studentNames[num] || '';
                                    saveCurrentState();
                                } else {
                                    alert("请输入1-47之间的有效数字");
                                }
                            }
                        });
                    }
                    tr.appendChild(td);
                });
                table.appendChild(tr);
            });
        }

        // 检查配对学生是否相邻
        function checkPair(pairNum, currentCell) {
            const table = document.getElementById('seatTable');
            const rows = table.querySelectorAll('tr');
            const currentTd = currentCell.closest('td');
            
            let currentRow = -1, currentCol = -1;
            rows.forEach((row, rowIndex) => {
                const cells = row.querySelectorAll('td');
                cells.forEach((cell, colIndex) => {
                    if (cell === currentTd) {
                        currentRow = rowIndex;
                        currentCol = colIndex;
                    }
                });
            });
            
            if (currentRow === -1 || currentCol === -1) return false;
            
            const directions = [
                [-1, 0], [1, 0], [0, -1], [0, 1]
            ];
            
            for (const [dr, dc] of directions) {
                const newRow = currentRow + dr;
                const newCol = currentCol + dc;
                
                if (newRow >= 0 && newRow < rows.length && 
                    newCol >= 0 && newCol < rows[newRow].querySelectorAll('td').length) {
                    const adjacentCell = rows[newRow].querySelectorAll('td')[newCol];
                    const numberSpan = adjacentCell.querySelector('.student-number');
                    if (numberSpan && parseInt(numberSpan.textContent) === pairNum) {
                        return true;
                    }
                }
            }
            
            return false;
        }

        // 保存当前状态到localStorage
        function saveCurrentState() {
            const table = document.getElementById('seatTable');
            const rows = table.querySelectorAll('tr');
            const currentData = [];
            
            rows.forEach(row => {
                const rowData = [];
                const cells = row.querySelectorAll('td');
                cells.forEach(cell => {
                    if (cell.classList.contains('teacher')) {
                        rowData.push(cell.textContent === "教师" ? "教师" : "的座位");
                    } else if (cell.classList.contains('empty')) {
                        rowData.push(null);
                    } else {
                        const numberSpan = cell.querySelector('.student-number');
                        rowData.push(numberSpan ? numberSpan.textContent : "");
                    }
                });
                currentData.push(rowData);
            });
            
            localStorage.setItem('seatTableData', JSON.stringify(currentData));
        }

        // 改进的随机分配座位函数
        function randomizeSeats() {
            const seats = Array.from(document.querySelectorAll('td:not(.empty):not(.teacher)'));
            let numbers = Array.from({length: 47}, (_, i) => i + 1);
            
            // 分离需要配对的学生和其他学生
            const pairedNumbers = [2, 30, 4, 42];
            const regularNumbers = numbers.filter(n => !pairedNumbers.includes(n));
            
            // 随机打乱常规学生
            shuffleArray(regularNumbers);
            
            // 先分配常规学生
            let seatIndex = 0;
            for (let i = 0; i < regularNumbers.length && seatIndex < seats.length; i++, seatIndex++) {
                const studentNum = regularNumbers[i];
                updateSeat(seats[seatIndex], studentNum);
            }
            
            // 处理配对1 (2和30)
            if (seatIndex < seats.length - 1) {
                const pair1 = [2, 30];
                shuffleArray(pair1);
                
                // 尝试找到相邻的两个座位
                const adjacentSeats = findAdjacentSeats(seats, seatIndex);
                if (adjacentSeats) {
                    updateSeat(adjacentSeats[0], pair1[0]);
                    updateSeat(adjacentSeats[1], pair1[1]);
                    seatIndex += 2;
                } else {
                    // 如果没有相邻座位，就放在任意两个座位
                    if (seatIndex < seats.length) updateSeat(seats[seatIndex++], pair1[0]);
                    if (seatIndex < seats.length) updateSeat(seats[seatIndex++], pair1[1]);
                }
            }
            
            // 处理配对2 (4和42)
            if (seatIndex < seats.length - 1) {
                const pair2 = [4, 42];
                shuffleArray(pair2);
                
                // 尝试找到相邻的两个座位
                const adjacentSeats = findAdjacentSeats(seats, seatIndex);
                if (adjacentSeats) {
                    updateSeat(adjacentSeats[0], pair2[0]);
                    updateSeat(adjacentSeats[1], pair2[1]);
                } else {
                    // 如果没有相邻座位，就放在任意两个座位
                    if (seatIndex < seats.length) updateSeat(seats[seatIndex++], pair2[0]);
                    if (seatIndex < seats.length) updateSeat(seats[seatIndex++], pair2[1]);
                }
            }
            
            saveCurrentState();
        }

        // 辅助函数：随机打乱数组
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        // 辅助函数：更新座位信息
        function updateSeat(seat, studentNum) {
            const numberSpan = seat.querySelector('.student-number');
            const nameSpan = seat.querySelector('.student-name');
            if (numberSpan && nameSpan) {
                numberSpan.textContent = studentNum;
                nameSpan.textContent = studentNames[studentNum] || '';
            }
        }

        // 辅助函数：查找相邻的两个空座位
        function findAdjacentSeats(seats, startIndex) {
            const table = document.getElementById('seatTable');
            const rows = table.querySelectorAll('tr');
            
            // 创建一个座位位置映射
            const seatPositions = new Map();
            seats.forEach((seat, index) => {
                if (index >= startIndex) {
                    for (let row = 0; row < rows.length; row++) {
                        const cells = rows[row].querySelectorAll('td');
                        for (let col = 0; col < cells.length; col++) {
                            if (cells[col] === seat) {
                                seatPositions.set(seat, {row, col, index});
                                return;
                            }
                        }
                    }
                }
            });
            
            // 查找相邻的座位对
            for (let i = startIndex; i < seats.length; i++) {
                const seat1 = seats[i];
                const pos1 = seatPositions.get(seat1);
                if (!pos1) continue;
                
                for (let j = i + 1; j < seats.length; j++) {
                    const seat2 = seats[j];
                    const pos2 = seatPositions.get(seat2);
                    if (!pos2) continue;
                    
                    // 检查是否相邻
                    const rowDiff = Math.abs(pos1.row - pos2.row);
                    const colDiff = Math.abs(pos1.col - pos2.col);
                    
                    if ((rowDiff === 1 && colDiff === 0) || (rowDiff === 0 && colDiff === 1)) {
                        return [seat1, seat2];
                    }
                }
            }
            
            return null;
        }

        // 重置座位表
        function resetTable() {
            if (confirm('确定要重置座位表吗？所有更改将丢失。')) {
                localStorage.removeItem('seatTableData');
                initializeTable();
            }
        }

        // 导出为PNG
        function exportToPNG() {
            const table = document.getElementById('seatTable');
            
            html2canvas(table, {
                backgroundColor: '#FFFFFF',
                scale: 2
            }).then(canvas => {
                const link = document.createElement('a');
                link.download = '座位表.png';
                link.href = canvas.toDataURL('image/png');
                link.click();
            });
        }
    
        // 初始化页面
        initializeTable();
        document.getElementById('randomizeBtn').addEventListener('click', randomizeSeats);
        document.getElementById('exportBtn').addEventListener('click', exportToPNG);
        document.getElementById('resetBtn').addEventListener('click', resetTable);
        
        // 设置当前年份
        document.getElementById('year').textContent = new Date().getFullYear();
    </script>
</body>
</html>
